<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="متجر الأناقة الفاخر - إكسسوارات عصرية: ساعات، أساور، خواتم، ميداليات">
    <meta name="author" content="Your Name">
    <meta name="keywords" content="إكسسوارات, ساعات ذكية, أساور, خواتم, ميداليات, تسوق">
    <meta property="og:title" content="متجر الأناقة - تسوق بأناقة لا تضاهى">
    <meta property="og:description" content="اكتشف مجموعتنا الفاخرة من الساعات، الأساور، الخواتم، والميداليات.">
    <meta property="og:image" content="https://via.placeholder.com/1200x630?text=متجر+الأناقة">
    <meta property="og:url" content="https://yourwebsite.com">
    <meta name="twitter:card" content="summary_large_image">
    <title>متجر الأناقة - تسوق بأناقة لا تضاهى</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <!-- Model Viewer for AR -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#232f3e">

    <!-- Custom CSS -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #f4f4f4;
            direction: rtl;
            text-align: right;
            transition: background 0.3s, color 0.3s;
            scroll-behavior: smooth;
        }

        body.dark-mode {
            background: #121212;
            color: #e0e0e0;
        }

        body.high-contrast {
            background: #000;
            color: #fff;
        }

        body.high-contrast a, body.high-contrast button {
            color: #ff0;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(90deg, #232f3e, #131921);
            color: #fff;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 3000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .navbar .logo {
            font-family: 'Amiri', serif;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s, transform 0.2s;
        }

        .navbar .logo:hover {
            color: #f0c14b;
            transform: scale(1.05);
        }

        .navbar .search-container {
            flex-grow: 1;
            margin: 0 30px;
            position: relative;
        }

        .navbar .search-container input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s;
        }

        .navbar .search-container input:focus {
            box-shadow: 0 0 8px rgba(240,193,75,0.5);
        }

        .navbar .search-container .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .navbar .search-container .search-icon:hover {
            color: #f0c14b;
        }

        .navbar .search-suggestions {
            position: absolute;
            top: 100%;
            right: 0;
            width: 100%;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 4000;
        }

        .navbar .search-suggestions div {
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .navbar .search-suggestions div:hover {
            background: #f0c14b;
            color: #232f3e;
        }

        .navbar .nav-links {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .navbar .nav-links a, .navbar .nav-links button {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s, transform 0.2s;
        }

        .navbar .nav-links a:hover, .navbar .nav-links button:hover {
            color: #f0c14b;
            transform: scale(1.05);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f0c14b;
            transition: transform 0.3s;
        }

        .user-profile img:hover {
            transform: rotate(10deg);
        }

        /* Dropdown */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            color: #232f3e;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            min-width: 250px;
            z-index: 5000;
        }

        .dropdown-content a {
            display: block;
            padding: 12px 20px;
            color: #232f3e;
            text-decoration: none;
            transition: background 0.2s;
        }

        .dropdown-content a:hover {
            background: #f0c14b;
            color: #fff;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Mobile Menu */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 70px;
                right: 0;
                background: #232f3e;
                width: 100%;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }

            .nav-links.active {
                display: flex;
            }

            .menu-toggle {
                display: block;
            }

            .navbar .search-container {
                margin: 10px 0;
            }
        }

        /* Hero */
        .hero {
            background: linear-gradient(135deg, #FF4B2B, #FF416C);
            color: #fff;
            padding: 60px 40px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 10px;
            position: relative;
            overflow: hidden;
            animation: heroFade 2s ease-in-out;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://via.placeholder.com/1400x400?text=إكسسوارات') center/cover;
            opacity: 0.2;
            z-index: 0;
        }

        .hero h1 {
            font-family: 'Amiri', serif;
            font-size: 48px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .hero p {
            font-family: 'Tajawal', sans-serif;
            font-size: 20px;
            position: relative;
            z-index: 1;
        }

        .hero .cta {
            background: #f0c14b;
            color: #232f3e;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            position: relative;
            z-index: 1;
        }

        .hero .cta:hover {
            background: #e0b038;
            transform: scale(1.1);
        }

        @keyframes heroFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Filters */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 10px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filters select, .filters input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            min-width: 150px;
        }

        .filters input[type="number"] {
            width: 100px;
        }

        /* Categories */
        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 20px 10px;
        }

        .category-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            text-align: center;
            padding: 25px;
            transition: transform 0.4s, box-shadow 0.4s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .category-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.3));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .category-card:hover::after {
            opacity: 1;
        }

        .category-card:hover {
            transform: translateY(-15px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.25);
        }

        .category-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: transform 0.4s;
        }

        .category-card:hover img {
            transform: scale(1.1);
        }

        .category-card h3 {
            font-family: 'Tajawal', sans-serif;
            font-size: 22px;
            color: #232f3e;
        }

        /* Products */
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 20px 10px;
        }

        .product-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            padding: 25px;
            text-align: center;
            transition: transform 0.4s, box-shadow 0.4s;
            cursor: pointer;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-15px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.25);
        }

        .product-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .product-card h3 {
            font-size: 20px;
            color: #232f3e;
            margin-bottom: 10px;
        }

        .product-card .price {
            color: #B12704;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-card .rating {
            color: #f0c14b;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .product-card .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .product-card .add-to-cart,
        .product-card .wishlist,
        .product-card .compare,
        .product-card .ar-preview,
        .product-card .share {
            background: #f0c14b;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .product-card .wishlist {
            background: #ddd;
        }

        .product-card .compare {
            background: #28a745;
            color: #fff;
        }

        .product-card .ar-preview {
            background: #007bff;
            color: #fff;
        }

        .product-card .share {
            background: #17a2b8;
            color: #fff;
        }

        .product-card .add-to-cart:hover {
            background: #e0b038;
            transform: scale(1.05);
        }

        .product-card .wishlist:hover {
            background: #ccc;
            transform: scale(1.05);
        }

        .product-card .compare:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .product-card .ar-preview:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .product-card .share:hover {
            background: #138496;
            transform: scale(1.05);
        }

        /* Product Detail */
        .product-detail {
            margin: 20px 10px;
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .product-detail-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .product-detail img {
            max-width: 400px;
            width: 100%;
            border-radius: 10px;
        }

        .product-detail .details {
            flex: 1;
            min-width: 300px;
        }

        .product-detail h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }

        .product-detail .review-form {
            margin-top: 20px;
        }

        .product-detail .review-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }

        .product-detail .review-form select {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 6000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            color: #232f3e;
            animation: modalFade 0.3s ease-in-out;
        }

        @keyframes modalFade {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close {
            background: #ddd;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .modal-close:hover {
            background: #ccc;
        }

        .checkout {
            background: #f0c14b;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            margin-right: 10px;
        }

        .checkout:hover {
            background: #e0b038;
        }

        /* Cart Item */
        .cart-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }

        .cart-item .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Recently Viewed */
        .recently-viewed {
            margin: 20px 10px;
        }

        .recently-viewed h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        /* Newsletter */
        .newsletter {
            background: #232f3e;
            color: #fff;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
        }

        .newsletter h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        .newsletter form {
            display: flex;
            justify-content: center;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .newsletter input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 100%;
            max-width: 300px;
        }

        .newsletter button {
            background: #f0c14b;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .newsletter button:hover {
            background: #e0b038;
        }

        /* Live Chat */
        .live-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: #fff;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 7000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .live-chat:hover {
            background: #0056b3;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 7000;
            transition: opacity 0.5s;
            opacity: 1;
            color: #fff;
        }

        .toast-success {
            background: #28a745;
        }

        .toast-error {
            background: #dc3545;
        }

        /* Lazy Loading */
        .lazy-load {
            background: #eee;
            width: 100%;
            height: 250px;
            border-radius: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { background: #eee; }
            50% { background: #ddd; }
            100% { background: #eee; }
        }

        /* Accessibility */
        button:focus, a:focus, input:focus, select:focus, textarea:focus {
            outline: 3px solid #f0c14b;
            outline-offset: 2px;
        }

        /* Infinite Scroll Loader */
        .loader {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loader.active {
            display: block;
        }

        /* Profile Section */
        .profile {
            margin: 20px 10px;
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .profile form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
        }

        .profile input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .profile button {
            background: #f0c14b;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .profile button:hover {
            background: #e0b038;
        }

        /* Orders Section */
        .orders {
            margin: 20px 10px;
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .order-item {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar" role="navigation" aria-label="التنقل الرئيسي">
        <div class="logo" onclick="showSection('categories')" role="button" aria-label="الانتقال إلى الفئات">متجر الأناقة</div>
        <button class="menu-toggle" id="menuToggle" aria-label="فتح القائمة" aria-expanded="false">
            <i class="fas fa-bars"></i>
        </button>
        <div class="search-container" role="search">
            <input type="text" id="searchInput" placeholder="ابحث عن ساعات، أساور، خواتم..." aria-label="البحث عن المنتجات">
            <i class="fas fa-search search-icon" role="button" aria-label="بحث"></i>
            <div class="search-suggestions" id="searchSuggestions" role="listbox"></div>
        </div>
        <div class="nav-links" id="navLinks">
            <div class="user-profile" id="userProfile">
                <span id="userName">وضع الضيف</span>
                <img id="userImage" src="https://via.placeholder.com/50" alt="صورة المستخدم" style="display: none;">
            </div>
            <div class="dropdown">
                <a href="#" id="accountLink">الحساب</a>
                <div class="dropdown-content">
                    <a href="#" id="loginLink">تسجيل الدخول</a>
                    <a href="#" id="logoutLink" style="display: none;">تسجيل الخروج</a>
                    <a href="#" id="ordersLink" style="display: none;" onclick="showSection('orders')">طلباتي</a>
                    <a href="#" id="wishlistLink" onclick="showSection('wishlist')">قائمة الأمنيات</a>
                    <a href="#" id="profileLink" style="display: none;" onclick="showSection('profile')">الملف الشخصي</a>
                    <a href="#" id="couponsLink" style="display: none;" onclick="showSection('coupons')">الكوبونات</a>
                </div>
            </div>
            <a href="#" class="cart" id="cartLink" onclick="showCart()">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cartCount">0</span>
            </a>
            <button class="theme-toggle" id="themeToggle" title="تبديل الوضع"><i class="fas fa-moon"></i></button>
            <button class="language-toggle" id="languageToggle" title="تغيير اللغة">العربية</button>
            <select id="currencyToggle" title="تغيير العملة">
                <option value="SAR">ر.س</option>
                <option value="USD">$</option>
                <option value="EUR">€</option>
            </select>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Guest Warning -->
        <div class="guest-warning" id="guestWarning">
            أنت في وضع الضيف. سجل الدخول للاستمتاع بالشراء، الكوبونات، المراجعات، وتجربة الواقع المعزز!
        </div>

        <!-- Hero Section -->
        <div class="hero">
            <h1>ارتقِ بأناقتك مع إكسسواراتنا الفاخرة</h1>
            <p>ساعات ذكية، أساور يدوية، خواتم مميزة، وميداليات فريدة تنتظرك</p>
            <button class="cta" onclick="showSection('categories')">تسوق الآن</button>
        </div>

        <!-- Filters -->
        <div class="filters">
            <select id="sortBy">
                <option value="">الترتيب حسب</option>
                <option value="price-asc">السعر: الأقل</option>
                <option value="price-desc">السعر: الأعلى</option>
                <option value="rating">التقييم</option>
                <option value="newest">الأحدث</option>
            </select>
            <select id="categoryFilter">
                <option value="">جميع الفئات</option>
                <option value="watches">ساعات</option>
                <option value="bracelets">أساور</option>
                <option value="rings">خواتم</option>
                <option value="medals">ميداليات</option>
            </select>
            <input type="number" id="minPrice" placeholder="السعر الأدنى">
            <input type="number" id="maxPrice" placeholder="السعر الأعلى">
            <input type="text" id="brandFilter" placeholder="البحث حسب العلامة التجارية">
            <select id="colorFilter">
                <option value="">جميع الألوان</option>
                <option value="أسود">أسود</option>
                <option value="فضي">فضي</option>
                <option value="ذهبي">ذهبي</option>
            </select>
            <select id="sizeFilter">
                <option value="">جميع الأحجام</option>
                <option value="42mm">42mm</option>
                <option value="46mm">46mm</option>
            </select>
        </div>

        <!-- Categories -->
        <div class="categories" id="categories"></div>

        <!-- Products -->
        <div class="products" id="products"></div>
        <div class="loader" id="loader"><i class="fas fa-spinner fa-spin"></i> جارٍ التحميل...</div>

        <!-- Product Detail -->
        <div class="product-detail" id="productDetail" style="display: none;"></div>

        <!-- Recently Viewed -->
        <div class="recently-viewed" id="recentlyViewed" style="display: none;">
            <h2>تمت مشاهدتها مؤخرًا</h2>
            <div class="products" id="recentlyViewedProducts"></div>
        </div>

        <!-- Wishlist -->
        <div class="wishlist" id="wishlist" style="display: none;">
            <h2>قائمة الأمنيات</h2>
            <div class="products" id="wishlistProducts"></div>
        </div>

        <!-- Profile -->
        <div class="profile" id="profile" style="display: none;">
            <h2>الملف الشخصي</h2>
            <form id="profileForm">
                <input type="text" id="profileName" placeholder="الاسم" required>
                <input type="url" id="profilePhoto" placeholder="رابط الصورة">
                <input type="text" id="profileAddress" placeholder="العنوان">
                <button type="submit">حفظ التغييرات</button>
            </form>
        </div>

        <!-- Orders -->
        <div class="orders" id="orders" style="display: none;">
            <h2>طلباتي</h2>
            <div id="orderList"></div>
        </div>

        <!-- Coupons -->
        <div class="coupons" id="coupons" style="display: none;">
            <h2>الكوبونات</h2>
            <div id="couponList"></div>
        </div>

        <!-- Newsletter -->
        <div class="newsletter">
            <h2>اشترك في النشرة الإخبارية</h2>
            <form id="newsletterForm">
                <input type="email" id="newsletterEmail" placeholder="أدخل بريدك الإلكتروني" required>
                <button type="submit">اشترك</button>
            </form>
        </div>

        <!-- Cart Modal -->
        <div class="modal" id="cartModal" role="dialog" aria-labelledby="cartTitle" aria-hidden="true">
            <div class="modal-content">
                <h2 id="cartTitle">عربة التسوق</h2>
                <div id="cartItems"></div>
                <div class="coupon-apply">
                    <input type="text" id="couponCode" placeholder="أدخل رمز الكوبون">
                    <button onclick="applyCoupon()">تطبيق الكوبون</button>
                </div>
                <div id="cartTotal">الإجمالي: 0 ر.س</div>
                <button class="modal-close" onclick="closeModal('cartModal')" aria-label="إغلاق العربة">إغلاق</button>
                <button class="checkout" onclick="checkout()" aria-label="الدفع">الدفع</button>
            </div>
        </div>

        <!-- AR Preview Modal -->
        <div class="modal" id="arModal" role="dialog" aria-labelledby="arTitle" aria-hidden="true">
            <div class="modal-content">
                <h2 id="arTitle">معاينة الواقع المعزز</h2>
                <div id="arPreview"></div>
                <button class="modal-close" onclick="closeModal('arModal')" aria-label="إغلاق المعاينة">إغلاق</button>
            </div>
        </div>

        <!-- Live Chat -->
        <div class="live-chat" id="liveChat" title="الدردشة المباشرة">
            <i class="fas fa-comment"></i>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBfXJ-2tmCYo-pQjfN_4nAdxC-NcqfjAlo",
            authDomain: "tamec-8f9ea.firebaseapp.com",
            projectId: "tamec-8f9ea",
            storageBucket: "tamec-8f9ea.firebasestorage.app",
            messagingSenderId: "372610375354",
            appId: "1:372610375354:web:1beaff9695e7b49cdeec83",
            measurementId: "G-W7TT6VTKSP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
    </script>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }
    </script>

    <!-- JavaScript -->
    <script>
        // Core Variables
        const allProducts = [
            { 
                id: 1, 
                name: "ساعة ذكية ألترا", 
                category: "watches", 
                price: 599, 
                image: "https://via.placeholder.com/300x250?text=ساعة+ذكية+ألترا", 
                model3d: "https://modelviewer.dev/assets/astronaut.glb", 
                description: "ساعة ذكية بتقنيات متطورة", 
                specs: { material: "تيتانيوم", display: "AMOLED 1.5\"", battery: "48 ساعة", features: ["GPS", "تتبع النوم", "مقاومة للماء"] }, 
                rating: 4.9, 
                brand: "TechTrend", 
                colors: ["أسود", "فضي"], 
                sizes: ["42mm", "46mm"], 
                stock: 50, 
                reviews: [{ user: "أحمد", rating: 5, comment: "مذهلة!" }] 
            },
            { 
                id: 2, 
                name: "سوار جلدي فاخر", 
                category: "bracelets", 
                price: 199, 
                image: "https://via.placeholder.com/300x250?text=سوار+جلدي", 
                model3d: "https://modelviewer.dev/assets/astronaut.glb", 
                description: "سوار مصنوع يدويًا من الجلد الطبيعي", 
                specs: { material: "جلد", length: "20 سم", features: ["مقاوم للماء"] }, 
                rating: 4.7, 
                brand: "LuxCraft", 
                colors: ["بني", "أسود"], 
                sizes: ["M", "L"], 
                stock: 30, 
                reviews: [{ user: "سارة", rating: 4, comment: "أنيق جدًا" }] 
            },
            // Add more products to reach 50+ for realism
        ];

        let cart = [];
        let wishlist = [];
        let compareList = [];
        let orders = [];
        let coupons = [
            { code: "SAVE10", discount: 10 },
            { code: "FREESHIP", discount: 0, freeShipping: true },
            { code: "WELCOME20", discount: 20 }
        ];
        let recentlyViewed = [];
        let isGuest = true;
        let language = 'ar';
        let currency = 'SAR';
        let exchangeRates = { SAR: 1, USD: 0.27, EUR: 0.24 };
        let appliedCoupon = null;
        let currentPage = 1;
        const productsPerPage = 12;

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.className = 'modal active';
            modal.setAttribute('aria-hidden', 'false');
            logEvent(analytics, `open_${modalId}`);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.className = 'modal';
            modal.setAttribute('aria-hidden', 'true');
        }

        function formatPrice(price) {
            const rate = exchangeRates[currency];
            let formatted = (price * rate).toFixed(2);
            if (currency === 'SAR') return `${formatted} ر.س`;
            if (currency === 'USD') return `$${formatted}`;
            if (currency === 'EUR') return `€${formatted}`;
        }

        // Mobile Menu Toggle
        document.getElementById('menuToggle').addEventListener('click', () => {
            const navLinks = document.getElementById('navLinks');
            const menuToggle = document.getElementById('menuToggle');
            const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
            navLinks.classList.toggle('active');
            menuToggle.setAttribute('aria-expanded', !isExpanded);
            logEvent(analytics, 'toggle_mobile_menu');
        });

        // Show Section
        function showSection(sectionId) {
            const sections = ['categories', 'products', 'productDetail', 'wishlist', 'profile', 'orders', 'coupons'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) section.style.display = id === sectionId ? 'block' : 'none';
            });
            document.getElementById('recentlyViewed').style.display = sectionId === 'products' && recentlyViewed.length > 0 ? 'block' : 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            logEvent(analytics, `view_${sectionId}`);
        }

        // Load Categories
        async function loadCategories() {
            const categoriesContainer = document.getElementById('categories');
            const categories = [
                { id: 'watches', name: language === 'ar' ? 'ساعات' : 'Watches', image: 'https://via.placeholder.com/250?text=ساعات' },
                { id: 'bracelets', name: language === 'ar' ? 'أساور' : 'Bracelets', image: 'https://via.placeholder.com/250?text=أساور' },
                { id: 'rings', name: language === 'ar' ? 'خواتم' : 'Rings', image: 'https://via.placeholder.com/250?text=خواتم' },
                { id: 'medals', name: language === 'ar' ? 'ميداليات' : 'Medals', image: 'https://via.placeholder.com/250?text=ميداليات' }
            ];
            
            categoriesContainer.innerHTML = categories.map(category => `
                <div class="category-card" onclick="filterByCategory('${category.id}')" role="button" aria-label="عرض ${category.name}">
                    <img src="${category.image}" alt="${category.name}" loading="lazy">
                    <h3>${category.name}</h3>
                </div>
            `).join('');
        }

        // Load Products with Infinite Scroll
        async function loadProducts(filters = {}, append = false) {
            const productsContainer = document.getElementById('products');
            const loader = document.getElementById('loader');
            let filteredProducts = [...allProducts];

            // Apply Filters
            if (filters.category) {
                filteredProducts = filteredProducts.filter(p => p.category === filters.category);
            }
            if (filters.minPrice) {
                filteredProducts = filteredProducts.filter(p => p.price >= parseFloat(filters.minPrice));
            }
            if (filters.maxPrice) {
                filteredProducts = filteredProducts.filter(p => p.price <= parseFloat(filters.maxPrice));
            }
            if (filters.brand) {
                filteredProducts = filteredProducts.filter(p => p.brand.toLowerCase().includes(filters.brand.toLowerCase()));
            }
            if (filters.color) {
                filteredProducts = filteredProducts.filter(p => p.colors.includes(filters.color));
            }
            if (filters.size) {
                filteredProducts = filteredProducts.filter(p => p.sizes.includes(filters.size));
            }
            if (filters.sortBy) {
                filteredProducts.sort((a, b) => {
                    if (filters.sortBy === 'price-asc') return a.price - b.price;
                    if (filters.sortBy === 'price-desc') return b.price - a.price;
                    if (filters.sortBy === 'rating') return b.rating - a.rating;
                    if (filters.sortBy === 'newest') return b.id - a.id;
                    return 0;
                });
            }

            // Pagination
            const start = (currentPage - 1) * productsPerPage;
            const end = start + productsPerPage;
            const paginatedProducts = filteredProducts.slice(0, end);

            const html = paginatedProducts.map(product => `
                <div class="product-card" role="article" aria-labelledby="product-${product.id}">
                    <img src="${product.image}" alt="${product.name}" loading="lazy" class="lazy-load" onload="this.classList.remove('lazy-load')">
                    <h3 id="product-${product.id}">${product.name}</h3>
                    <div class="price">${formatPrice(product.price)}</div>
                    <div class="rating">${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}</div>
                    <div class="actions">
                        <button class="add-to-cart" onclick="addToCart(${product.id})" aria-label="إضافة ${product.name} إلى العربة">إضافة إلى العربة</button>
                        <button class="wishlist${wishlist.includes(product.id) ? ' active' : ''}" onclick="toggleWishlist(${product.id})" aria-label="${wishlist.includes(product.id) ? 'إزالة' : 'إضافة'} ${product.name} إلى قائمة الأمنيات">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="compare${compareList.includes(product.id) ? ' active' : ''}" onclick="toggleCompare(${product.id})" aria-label="${compareList.includes(product.id) ? 'إزالة' : 'إضافة'} ${product.name} إلى المقارنة">
                            <i class="fas fa-balance-scale"></i>
                        </button>
                        <button class="ar-preview" onclick="showARPreview(${product.id})" aria-label="معاينة ${product.name} بالواقع المعزز">AR</button>
                        <button class="share" onclick="shareProduct(${product.id})" aria-label="مشاركة ${product.name}">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            if (append) {
                productsContainer.innerHTML += html;
            } else {
                productsContainer.innerHTML = html;
            }

            // Lazy Loading
            const lazyImages = document.querySelectorAll('img[loading="lazy"]');
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.getAttribute('src');
                        observer.unobserve(img);
                    }
                });
            });
            lazyImages.forEach(img => observer.observe(img));

            // Infinite Scroll
            if (end < filteredProducts.length) {
                loader.className = 'loader active';
                window.onscroll = () => {
                    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                        currentPage++;
                        loadProducts(filters, true);
                    }
                };
            } else {
                loader.className = 'loader';
                window.onscroll = null;
            }
        }

        // Search Functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const suggestionsContainer = document.getElementById('searchSuggestions');
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            const suggestions = allProducts.filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.description.toLowerCase().includes(query) ||
                p.brand.toLowerCase().includes(query) ||
                p.category.toLowerCase().includes(query)
            ).slice(0, 5);

            suggestionsContainer.innerHTML = suggestions.map(p => `
                <div onclick="viewProduct(${p.id})" role="option" aria-label="عرض ${p.name}">${p.name} - ${p.brand}</div>
            `).join('');
            suggestionsContainer.style.display = suggestions.length ? 'block' : 'none';
            logEvent(analytics, 'search', { search_term: query });
        });

        // Cart Functions
        async function addToCart(productId, color = null, size = null) {
            if (isGuest) {
                showToast('سجل الدخول لإضافة المنتجات إلى العربة', 'error');
                return;
            }
            const product = allProducts.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                showToast('المنتج غير متوفر', 'error');
                return;
            }

            const cartItem = cart.find(item => item.id === productId && item.color === color && item.size === size);
            if (cartItem) {
                cartItem.quantity += 1;
            } else {
                cart.push({ id: productId, quantity: 1, color, size });
            }

            updateCartUI();
            
            if (!isGuest) {
                try {
                    await setDoc(doc(db, 'users', auth.currentUser.uid, 'cart', `${productId}_${color || ''}_${size || ''}`), {
                        quantity: cartItem ? cartItem.quantity : 1,
                        color,
                        size
                    });
                    showToast(`${product.name} أُضيف إلى العربة`);
                    logEvent(analytics, 'add_to_cart', { product_id: productId });
                } catch (error) {
                    showToast('خطأ أثناء إضافة المنتج', 'error');
                    console.error(error);
                }
            }
        }

        function updateCartUI() {
            document.getElementById('cartCount').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            showCart();
        }

        function showCart() {
            const cartItemsContainer = document.getElementById('cartItems');
            const cartTotalContainer = document.getElementById('cartTotal');
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>العربة فارغة</p>';
                cartTotalContainer.textContent = `الإجمالي: ${formatPrice(0)}`;
            } else {
                let total = 0;
                cartItemsContainer.innerHTML = cart.map(item => {
                    const product = allProducts.find(p => p.id === item.id);
                    const itemTotal = product.price * item.quantity;
                    total += itemTotal;
                    return `
                        <div class="cart-item">
                            <img src="${product.image}" alt="${product.name}">
                            <div>
                                <h4>${product.name}</h4>
                                <p>${item.color ? `اللون: ${item.color}` : ''} ${item.size ? `الحجم: ${item.size}` : ''}</p>
                                <p>${formatPrice(itemTotal)} (${formatPrice(product.price)} × ${item.quantity})</p>
                                <div class="quantity-controls">
                                    <button onclick="updateCartQuantity(${item.id}, '${item.color || ''}', '${item.size || ''}', ${item.quantity - 1})" aria-label="تقليل كمية ${product.name}">-</button>
                                    <span>${item.quantity}</span>
                                    <button onclick="updateCartQuantity(${item.id}, '${item.color || ''}', '${item.size || ''}', ${item.quantity + 1})" aria-label="زيادة كمية ${product.name}">+</button>
                                    <button onclick="removeFromCart(${item.id}, '${item.color || ''}', '${item.size || ''}')" aria-label="إزالة ${product.name} من العربة">إزالة</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                if (appliedCoupon) {
                    if (appliedCoupon.discount) {
                        total *= (100 - appliedCoupon.discount) / 100;
                    }
                    if (appliedCoupon.freeShipping) {
                        total += 0; // Placeholder for shipping cost
                    }
                }
                cartTotalContainer.textContent = `الإجمالي: ${formatPrice(total)}`;
            }
            openModal('cartModal');
        }

        async function updateCartQuantity(productId, color, size, quantity) {
            if (quantity <= 0) {
                removeFromCart(productId, color, size);
                return;
            }
            const product = allProducts.find(p => p.id === productId);
            if (quantity > product.stock) {
                showToast('الكمية المطلوبة غير متوفرة', 'error');
                return;
            }

            cart = cart.map(item => 
                item.id === productId && item.color === color && item.size === size 
                ? { ...item, quantity } 
                : item
            );
            updateCartUI();

            if (!isGuest) {
                try {
                    await setDoc(doc(db, 'users', auth.currentUser.uid, 'cart', `${productId}_${color || ''}_${size || ''}`), { 
                        quantity,
                        color,
                        size
                    });
                } catch (error) {
                    showToast('خطأ أثناء تحديث العربة', 'error');
                    console.error(error);
                }
            }
        }

        async function removeFromCart(productId, color, size) {
            cart = cart.filter(item => !(item.id === productId && item.color === color && item.size === size));
            updateCartUI();

            if (!isGuest) {
                try {
                    await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'cart', `${productId}_${color || ''}_${size || ''}`));
                } catch (error) {
                    showToast('خطأ أثناء إزالة المنتج', 'error');
                    console.error(error);
                }
            }
        }

        async function applyCoupon() {
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            const coupon = coupons.find(c => c.code === code);
            if (!coupon) {
                showToast('رمز الكوبون غير صالح', 'error');
                return;
            }
            appliedCoupon = coupon;
            showCart();
            showToast(`تم تطبيق الكوبون ${code} بنجاح`);
            logEvent(analytics, 'apply_coupon', { coupon_code: code });
        }

        async function checkout() {
            if (isGuest) {
                showToast('سجل الدخول لإتمام الدفع', 'error');
                return;
            }
            if (cart.length === 0) {
                showToast('العربة فارغة', 'error');
                return;
            }

            const order = {
                items: cart,
                total: cart.reduce((sum, item) => {
                    const product = allProducts.find(p => p.id === item.id);
                    return sum + product.price * item.quantity;
                }, 0),
                coupon: appliedCoupon,
                date: new Date(),
                status: 'pending'
            };

            if (appliedCoupon) {
                if (appliedCoupon.discount) {
                    order.total *= (100 - appliedCoupon.discount) / 100;
                }
                if (appliedCoupon.freeShipping) {
                    order.total += 0; // Placeholder for shipping cost
                }
            }

            try {
                await addDoc(collection(db, 'users', auth.currentUser.uid, 'orders'), order);
                orders.push(order);
                cart = [];
                appliedCoupon = null;
                updateCartUI();
                showSection('orders');
                showToast('تم تقديم الطلب بنجاح', 'success');
                logEvent(analytics, 'checkout', { order_total: order.total });
            } catch (error) {
                showToast('خطأ أثناء معالجة الطلب', 'error');
                console.error(error);
            }
        }

        // Wishlist Functions
        async function toggleWishlist(productId) {
            if (isGuest) {
                showToast('سجل الدخول لإضافة المنتجات إلى قائمة الأمنيات', 'error');
                return;
            }
            if (wishlist.includes(productId)) {
                wishlist = wishlist.filter(id => id !== productId);
                showToast('تمت الإزالة من قائمة الأمنيات');
                if (!isGuest) {
                    try {
                        await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'wishlist', productId.toString()));
                    } catch (error) {
                        showToast('خطأ أثناء تحديث قائمة الأمنيات', 'error');
                        console.error(error);
                    }
                }
            } else {
                wishlist.push(productId);
                showToast('تمت الإضافة إلى قائمة الأمنيات');
                if (!isGuest) {
                    try {
                        await setDoc(doc(db, 'users', auth.currentUser.uid, 'wishlist', productId.toString()), {
                            addedAt: new Date()
                        });
                    } catch (error) {
                        showToast('خطأ أثناء تحديث قائمة الأمنيات', 'error');
                        console.error(error);
                    }
                }
            }
            loadProducts();
            showWishlist();
            logEvent(analytics, wishlist.includes(productId) ? 'add_to_wishlist' : 'remove_from_wishlist', { product_id: productId });
        }

        function showWishlist() {
            const wishlistContainer = document.getElementById('wishlistProducts');
            if (wishlist.length === 0) {
                wishlistContainer.innerHTML = '<p>قائمة الأمنيات فارغة</p>';
            } else {
                wishlistContainer.innerHTML = wishlist.map(id => {
                    const product = allProducts.find(p => p.id === id);
                    return `
                        <div class="product-card" role="article" aria-labelledby="wishlist-${product.id}">
                            <img src="${product.image}" alt="${product.name}" loading="lazy">
                            <h3 id="wishlist-${product.id}">${product.name}</h3>
                            <div class="price">${formatPrice(product.price)}</div>
                            <div class="rating">${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}</div>
                            <div class="actions">
                                <button class="add-to-cart" onclick="addToCart(${product.id})" aria-label="إضافة ${product.name} إلى العربة">إضافة إلى العربة</button>
                                <button class="wishlist active" onclick="toggleWishlist(${product.id})" aria-label="إزالة ${product.name} من قائمة الأمنيات">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Compare Functions
        function toggleCompare(productId) {
            if (compareList.includes(productId)) {
                compareList = compareList.filter(id => id !== productId);
                showToast('تمت الإزالة من المقارنة');
            } else {
                if (compareList.length >= 4) {
                    showToast('يمكنك مقارنة 4 منتجات فقط', 'error');
                    return;
                }
                compareList.push(productId);
                showToast('تمت الإضافة إلى المقارنة');
            }
            loadProducts();
            logEvent(analytics, compareList.includes(productId) ? 'add_to_compare' : 'remove_from_compare', { product_id: productId });
        }

        // AR Preview
        function showARPreview(productId) {
            const product = allProducts.find(p => p.id === productId);
            const arPreviewContainer = document.getElementById('arPreview');
            arPreviewContainer.innerHTML = `
                <model-viewer src="${product.model3d}" alt="${product.name}" auto-rotate camera-controls ar ios-src="${product.model3d}" style="width: 100%; height: 400px;">
                    <button slot="ar-button" style="background: #f0c14b; border: none; padding: 10px; border-radius: 5px; position: absolute; bottom: 20px; right: 20px;">
                        تفعيل الواقع المعزز
                    </button>
                </model-viewer>
            `;
            openModal('arModal');
            logEvent(analytics, 'view_ar_preview', { product_id: productId });
        }

        // Share Product
        function shareProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (navigator.share) {
                navigator.share({
                    title: product.name,
                    text: product.description,
                    url: window.location.href + `#product-${productId}`
                }).catch(err => console.error('Share failed:', err));
            } else {
                showToast('المشاركة غير مدعومة في هذا المتصفح. انسخ الرابط يدويًا.', 'error');
            }
            logEvent(analytics, 'share_product', { product_id: productId });
        }

        // Recently Viewed
        function updateRecentlyViewed(productId) {
            if (!recentlyViewed.includes(productId)) {
                recentlyViewed.unshift(productId);
                recentlyViewed = recentlyViewed.slice(0, 5);
                const recentlyViewedContainer = document.getElementById('recentlyViewedProducts');
                recentlyViewedContainer.innerHTML = recentlyViewed.map(id => {
                    const product = allProducts.find(p => p.id === id);
                    return `
                        <div class="product-card" role="article" aria-labelledby="recent-${product.id}">
                            <img src="${product.image}" alt="${product.name}" loading="lazy">
                            <h3 id="recent-${product.id}">${product.name}</h3>
                            <div class="price">${formatPrice(product.price)}</div>
                            <div class="rating">${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}</div>
                            <div class="actions">
                                <button class="add-to-cart" onclick="addToCart(${product.id})" aria-label="إضافة ${product.name} إلى العربة">إضافة إلى العربة</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Product Detail
        function viewProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            updateRecentlyViewed(productId);
            showSection('productDetail');
            const productDetailContainer = document.getElementById('productDetail');
            productDetailContainer.innerHTML = `
                <div class="product-detail-content" role="article" aria-labelledby="detail-${product.id}">
                    <img src="${product.image}" alt="${product.name}" loading="lazy">
                    <div class="details">
                        <h2 id="detail-${product.id}">${product.name}</h2>
                        <p>${product.description}</p>
                        <div class="price">${formatPrice(product.price)}</div>
                        <div class="rating">${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}</div>
                        <p><strong>العلامة التجارية:</strong> ${product.brand}</p>
                        <p><strong>الألوان:</strong> 
                            <select id="colorSelect-${product.id}">
                                ${product.colors.map(color => `<option value="${color}">${color}</option>`).join('')}
                            </select>
                        </p>
                        <p><strong>الأحجام:</strong> 
                            <select id="sizeSelect-${product.id}">
                                ${product.sizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                            </select>
                        </p>
                        <p><strong>المخزون:</strong> ${product.stock} متبقي</p>
                        <button class="add-to-cart" onclick="addToCart(${product.id}, document.getElementById('colorSelect-${product.id}').value, document.getElementById('sizeSelect-${product.id}').value)" aria-label="إضافة ${product.name} إلى العربة">إضافة إلى العربة</button>
                        <button class="wishlist${wishlist.includes(product.id) ? ' active' : ''}" onclick="toggleWishlist(${product.id})" aria-label="${wishlist.includes(product.id) ? 'إزالة' : 'إضافة'} ${product.name} إلى قائمة الأمنيات">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="ar-preview" onclick="showARPreview(${product.id})" aria-label="معاينة ${product.name} بالواقع المعزز">AR</button>
                        <button class="share" onclick="shareProduct(${product.id})" aria-label="مشاركة ${product.name}">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <div class="review-form">
                            <h3>أضف مراجعتك</h3>
                            <select id="reviewRating-${product.id}" required>
                                <option value="">اختر التقييم</option>
                                ${[1,2,3,4,5].map(n => `<option value="${n}">${n} نجوم</option>`).join('')}
                            </select>
                            <textarea id="reviewComment-${product.id}" placeholder="اكتب تعليقك..." required></textarea>
                            <button onclick="submitReview(${product.id})">إرسال المراجعة</button>
                        </div>
                        <h3>المراجعات</h3>
                        ${product.reviews.map(review => `
                            <div class="review">
                                <p><strong>${review.user}</strong>: ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</p>
                                <p>${review.comment}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            logEvent(analytics, 'view_product', { product_id: productId });
        }

        async function submitReview(productId) {
            if (isGuest) {
                showToast('سجل الدخول لإضافة مراجعة', 'error');
                return;
            }
            const rating = parseInt(document.getElementById(`reviewRating-${productId}`).value);
            const comment = document.getElementById(`reviewComment-${productId}`).value.trim();
            if (!rating || !comment) {
                showToast('يرجى إكمال جميع الحقول', 'error');
                return;
            }

            const review = {
                user: auth.currentUser.displayName || 'مستخدم',
                rating,
                comment,
                date: new Date()
            };

            const product = allProducts.find(p => p.id === productId);
            product.reviews.push(review);

            try {
                await setDoc(doc(db, 'products', productId.toString(), 'reviews', `${auth.currentUser.uid}_${Date.now()}`), review);
                showToast('تم إرسال المراجعة بنجاح');
                viewProduct(productId);
                logEvent(analytics, 'submit_review', { product_id: productId, rating });
            } catch (error) {
                showToast('خطأ أثناء إرسال المراجعة', 'error');
                console.error(error);
            }
        }

        // Filter by Category
        function filterByCategory(categoryId) {
            document.getElementById('categoryFilter').value = categoryId;
            currentPage = 1;
            loadProducts({ category: categoryId });
        }

        // Theme Toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeToggle').innerHTML = `<i class="fas fa-${isDark ? 'sun' : 'moon'}"></i>`;
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            logEvent(analytics, 'toggle_theme', { theme: isDark ? 'dark' : 'light' });
        });

        // Language Toggle
        document.getElementById('languageToggle').addEventListener('click', () => {
            language = language === 'ar' ? 'en' : 'ar';
            document.documentElement.setAttribute('lang', language);
            document.documentElement.setAttribute('dir', language === 'ar' ? 'rtl' : 'ltr');
            document.getElementById('languageToggle').textContent = language === 'ar' ? 'العربية' : 'English';
            document.querySelector('.logo').textContent = language === 'ar' ? 'متجر الأناقة' : 'Elegance Store';
            document.getElementById('searchInput').placeholder = language === 'ar' ? 'ابحث عن ساعات، أساور، خواتم...' : 'Search for watches, bracelets, rings...';
            loadCategories();
            loadProducts();
            showSection('categories');
            localStorage.setItem('language', language);
            logEvent(analytics, 'toggle_language', { language });
        });

        // Currency Toggle
        document.getElementById('currencyToggle').addEventListener('change', () => {
            currency = document.getElementById('currencyToggle').value;
            loadProducts();
            showCart();
            viewProduct(allProducts[0].id);
            localStorage.setItem('currency', currency);
            logEvent(analytics, 'toggle_currency', { currency });
        });

        // Newsletter Signup
        document.getElementById('newsletterForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('newsletterEmail').value;
            try {
                await addDoc(collection(db, 'subscriptions'), { email, date: new Date() });
                showToast('تم الاشتراك بنجاح', 'success');
                document.getElementById('newsletterEmail').value = '';
                logEvent(analytics, 'newsletter_signup', { email });
            } catch (error) {
                showToast('خطأ أثناء الاشتراك', 'error');
                console.error(error);
            }
        });

        // Live Chat
        document.getElementById('liveChat').addEventListener('click', () => {
            showToast('الدردشة المباشرة قيد التطوير. تواصلوا عبر البريد الإلكتروني.', 'success');
            logEvent(analytics, 'open_live_chat');
        });

        // Profile Management
        document.getElementById('profileForm').addEventListener('submit', async e => {
            e.preventDefault();
            if (isGuest) {
                showToast('سجل الدخول لتحديث الملف الشخصي', 'error');
                return;
            }
            const name = document.getElementById('profileName').value;
            const photo = document.getElementById('profilePhoto').value;
            const address = document.getElementById('profileAddress').value;

            try {
                await updateProfile(auth.currentUser, { displayName: name, photoURL: photo });
                await setDoc(doc(db, 'users', auth.currentUser.uid), { address }, { merge: true });
                document.getElementById('userName').textContent = name;
                document.getElementById('userImage').src = photo || "https://via.placeholder.com/50";
                showToast('تم تحديث الملف الشخصي بنجاح');
                logEvent(analytics, 'update_profile');
            } catch (error) {
                showToast('خطأ أثناء تحديث الملف الشخصي', 'error');
                console.error(error);
            }
        });

        // Load Orders
        async function loadOrders() {
            const orderList = document.getElementById('orderList');
            if (isGuest) {
                orderList.innerHTML = '<p>سجل الدخول لعرض الطلبات</p>';
                return;
            }
            try {
                const snapshot = await getDocs(collection(db, 'users', auth.currentUser.uid, 'orders'));
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                orderList.innerHTML = orders.length === 0 ? '<p>لا توجد طلبات</p>' : orders.map(order => `
                    <div class="order-item">
                        <p><strong>تاريخ الطلب:</strong> ${new Date(order.date.seconds * 1000).toLocaleDateString()}</p>
                        <p><strong>الإجمالي:</strong> ${formatPrice(order.total)}</p>
                        <p><strong
